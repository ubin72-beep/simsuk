<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>심석 관리자</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- Header -->
    <header class="admin-header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-gem"></i>
                    <h1>심석 관리자</h1>
                </div>
                <div class="header-actions">
                    <button id="autoRefreshToggle" onclick="toggleAutoRefresh()" class="btn btn-primary" style="margin-right: 10px;">
                        <i class="fas fa-sync fa-spin"></i> 자동새로고침 중
                    </button>
                    <a href="index.html" class="btn btn-outline">
                        <i class="fas fa-home"></i> 메인 페이지로
                    </a>
                    <button onclick="logout()" class="btn btn-outline" style="margin-left: 10px;">
                        <i class="fas fa-sign-out-alt"></i> 로그아웃
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="admin-main">
        <div class="container">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #2c5f4f, #1a4034);">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">전체 제품</div>
                        <div class="stat-value" id="totalProducts">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #d4af37, #c19b2f);">
                        <i class="fas fa-gem"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">목걸이</div>
                        <div class="stat-value" id="necklaceCount">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #ee5a6f);">
                        <i class="fas fa-hand-sparkles"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">팔찌</div>
                        <div class="stat-value" id="braceletCount">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4ecdc4, #44a08d);">
                        <i class="fas fa-ring"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">반지</div>
                        <div class="stat-value" id="ringCount">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">핸드폰 줄</div>
                        <div class="stat-value" id="phoneStrapCount">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">전체 주문</div>
                        <div class="stat-value" id="totalOrders">0</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">대기 주문</div>
                        <div class="stat-value" id="pendingOrders">0</div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tab-navigation">
                <button class="tab-btn" onclick="switchTab('dashboard', event)">
                    <i class="fas fa-chart-line"></i>
                    <span>대시보드</span>
                </button>
                <button class="tab-btn active" onclick="switchTab('products', event)">
                    <i class="fas fa-box"></i>
                    <span>제품 관리</span>
                    <span class="badge" id="productsTabBadge" style="display:none;">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('orders', event)">
                    <i class="fas fa-shopping-cart"></i>
                    <span>주문 관리</span>
                    <span class="badge" id="ordersTabBadge" style="display:none;">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('discounts', event)">
                    <i class="fas fa-tags"></i>
                    <span>할인 관리</span>
                    <span class="badge" id="discountsTabBadge" style="display:none;">0</span>
                </button>
                <button class="tab-btn" onclick="switchTab('discounts', event)">
                    <i class="fas fa-tags"></i>
                    <span>할인 관리</span>
                    <span class="badge" id="discountsTabBadge" style="display:none; background: #e74c3c;">0</span>
                </button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 20px;">
                    <!-- 매출 그래프 -->
                    <div class="table-container" style="padding: 30px;">
                        <h3 style="margin-bottom: 20px; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-area"></i> 일별 매출 현황 (최근 7일)
                        </h3>
                        <canvas id="salesChart" style="height: 300px !important;"></canvas>
                    </div>
                    
                    <!-- 카테고리별 판매 -->
                    <div class="table-container" style="padding: 30px;">
                        <h3 style="margin-bottom: 20px; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-chart-pie"></i> 카테고리별 판매 비율
                        </h3>
                        <canvas id="categoryChart" style="height: 300px !important;"></canvas>
                    </div>
                </div>
                
                <!-- 인기 제품 -->
                <div class="table-container" style="margin-top: 20px;">
                    <div class="table-header">
                        <h2><i class="fas fa-fire"></i> 인기 제품 TOP 5</h2>
                    </div>
                    <div id="topProductsContainer" style="padding: 30px;">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>데이터 로딩 중...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 최근 추가한 제품 -->
                <div class="table-container" style="margin-top: 20px;">
                    <div class="table-header">
                        <h2><i class="fas fa-box-open"></i> 최근 추가한 제품</h2>
                        <button class="btn btn-secondary" onclick="switchTab('products', event)">
                            <i class="fas fa-list"></i> 전체 제품 보기
                        </button>
                    </div>
                    <div id="recentProductsContainer" style="padding: 30px;">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>데이터 로딩 중...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 최근 주문 -->
                <div class="table-container" style="margin-top: 20px;">
                    <div class="table-header">
                        <h2><i class="fas fa-clock"></i> 최근 주문 5건</h2>
                        <button class="btn btn-secondary" onclick="switchTab('orders', event)">
                            <i class="fas fa-list"></i> 전체 주문 보기
                        </button>
                    </div>
                    <div id="recentOrdersContainer"></div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="productsTab" class="tab-content active">
                <div class="table-container">
                    <div class="table-header">
                        <h2><i class="fas fa-box"></i> 제품 목록</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="showAddProductModal()">
                                <i class="fas fa-plus"></i> 새 제품 추가
                            </button>
                            <button class="btn btn-secondary" onclick="loadProducts()">
                                <i class="fas fa-sync"></i> 새로고침
                            </button>
                            <button class="btn btn-secondary" onclick="exportProductsCSV()">
                                <i class="fas fa-download"></i> CSV 다운로드
                            </button>
                        </div>
                    </div>
                    <div style="padding: 20px; border-bottom: 2px solid var(--border-color); background: white;">
                        <!-- 검색 + 정렬 -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="flex: 2; min-width: 250px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666; font-size: 0.9rem;">
                                    <i class="fas fa-search"></i> 검색
                                </label>
                                <input type="text" id="productSearchInput" placeholder="제품명, 재료, 효능 검색..." 
                                       onkeyup="searchProducts()" class="filter-select" 
                                       style="width: 100%; padding: 10px 15px;">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666; font-size: 0.9rem;">
                                    <i class="fas fa-sort"></i> 정렬
                                </label>
                                <select id="productSortSelect" onchange="sortProducts()" class="filter-select" style="width: 100%;">
                                    <option value="name-asc">이름 (가나다순)</option>
                                    <option value="name-desc">이름 (역순)</option>
                                    <option value="price-asc">가격 (낮은순)</option>
                                    <option value="price-desc">가격 (높은순)</option>
                                    <option value="date-desc">최신 등록순</option>
                                    <option value="date-asc">오래된 순</option>
                                </select>
                            </div>
                        </div>
                        <!-- 필터 -->
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666; font-size: 0.9rem;">
                                    <i class="fas fa-filter"></i> 카테고리
                                </label>
                                <select id="productCategoryFilter" onchange="filterProducts()" class="filter-select" style="width: 100%;">
                                    <option value="all">전체 카테고리</option>
                                    <option value="목걸이">목걸이</option>
                                    <option value="팔찌">팔찌</option>
                                    <option value="반지">반지</option>
                                    <option value="핸드폰 줄">핸드폰 줄</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666; font-size: 0.9rem;">
                                    <i class="fas fa-birthday-cake"></i> 탄생석
                                </label>
                                <select id="productBirthstoneFilter" onchange="filterProducts()" class="filter-select" style="width: 100%;">
                                    <option value="all">전체 탄생석</option>
                                    <option value="1">1월 (가넷)</option>
                                    <option value="2">2월 (자수정)</option>
                                    <option value="3">3월 (아쿠아마린)</option>
                                    <option value="4">4월 (다이아몬드)</option>
                                    <option value="5">5월 (에메랄드)</option>
                                    <option value="6">6월 (진주)</option>
                                    <option value="7">7월 (루비)</option>
                                    <option value="8">8월 (페리도트)</option>
                                    <option value="9">9월 (사파이어)</option>
                                    <option value="10">10월 (오팔)</option>
                                    <option value="11">11월 (토파즈)</option>
                                    <option value="12">12월 (터키석)</option>
                                    <option value="none">탄생석 미지정</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 200px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666; font-size: 0.9rem;">
                                    <i class="fas fa-gift"></i> 특별한 날
                                </label>
                                <select id="productOccasionFilter" onchange="filterProducts()" class="filter-select" style="width: 100%;">
                                    <option value="all">전체</option>
                                    <option value="valentine">💕 발렌타인데이</option>
                                    <option value="whiteday">🤍 화이트데이</option>
                                    <option value="parents">🌹 어버이날</option>
                                    <option value="birthday">🎂 생일 선물</option>
                                    <option value="anniversary">💍 결혼기념일</option>
                                    <option value="graduation">🎓 졸업 선물</option>
                                    <option value="christmas">🎄 크리스마스</option>
                                    <option value="none">미지정</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive" id="productsTableContainer"></div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content">
                <div class="table-container">
                    <div class="table-header">
                        <h2><i class="fas fa-shopping-cart"></i> 주문 목록</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="loadOrders()">
                                <i class="fas fa-sync"></i> 새로고침
                            </button>
                            <button class="btn btn-secondary" onclick="exportOrdersDetailCSV()">
                                <i class="fas fa-download"></i> CSV 다운로드
                            </button>
                        </div>
                    </div>
                    <div style="padding: 20px; border-bottom: 2px solid var(--border-color); background: white;">
                        <!-- 검색 + 정렬 -->
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <div style="flex: 2; min-width: 250px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666; font-size: 0.9rem;">
                                    <i class="fas fa-search"></i> 검색
                                </label>
                                <input type="text" id="orderSearchInput" placeholder="주문번호, 고객명, 전화번호 검색..." 
                                       onkeyup="searchOrders()" class="filter-select" 
                                       style="width: 100%; padding: 10px 15px;">
                            </div>
                            <div style="flex: 1; min-width: 180px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666; font-size: 0.9rem;">
                                    <i class="fas fa-sort"></i> 정렬
                                </label>
                                <select id="orderSortSelect" onchange="sortOrders()" class="filter-select" style="width: 100%;">
                                    <option value="date-desc">최신 주문순</option>
                                    <option value="date-asc">오래된 순</option>
                                    <option value="amount-desc">금액 (높은순)</option>
                                    <option value="amount-asc">금액 (낮은순)</option>
                                </select>
                            </div>
                        </div>
                        <!-- 필터 -->
                        <div style="max-width: 300px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #666; font-size: 0.9rem;">
                                <i class="fas fa-filter"></i> 주문 상태
                            </label>
                            <select id="orderStatusFilter" onchange="filterOrders()" class="filter-select" style="width: 100%;">
                                <option value="all">전체 상태</option>
                                <option value="접수">접수</option>
                                <option value="확인중">확인중</option>
                                <option value="배송준비">배송준비</option>
                                <option value="배송중">배송중</option>
                                <option value="배송완료">배송완료</option>
                                <option value="취소">취소</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive" id="ordersTableContainer"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Discounts Tab -->
    <div id="discountsTab" class="tab-content">
        <div class="table-container">
            <div class="table-header">
                <h2><i class="fas fa-tags"></i> 할인 관리</h2>
                <div class="table-actions">
                    <button class="btn btn-primary" onclick="showAddDiscountModal()">
                        <i class="fas fa-plus"></i> 새 할인 추가
                    </button>
                    <button class="btn btn-secondary" onclick="loadDiscounts()">
                        <i class="fas fa-sync"></i> 새로고침
                    </button>
                </div>
            </div>
            <div style="padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; margin: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle" style="color: #ff9800; font-size: 1.5rem;"></i>
                    <div>
                        <strong style="color: #f57c00;">할인 정책 안내</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">
                            활성화된 할인은 즉시 메인 페이지에 반영됩니다. 기간이 지난 할인은 자동으로 비활성화됩니다.
                        </p>
                    </div>
                </div>
            </div>
            <div class="table-responsive" id="discountsTableContainer"></div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-overlay" onclick="closeProductModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">새 제품 추가</h2>
                <button class="modal-close" onclick="closeProductModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="productForm" onsubmit="handleProductSubmit(event)">
                    <input type="hidden" id="productId">
                    
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> 제품명 *</label>
                        <input type="text" id="productName" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-list"></i> 카테고리 *</label>
                        <select id="productCategory" required>
                            <option value="목걸이">목걸이</option>
                            <option value="팔찌">팔찌</option>
                            <option value="반지">반지</option>
                            <option value="핸드폰 줄">핸드폰 줄</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-won-sign"></i> 가격 *</label>
                        <input type="number" id="productPrice" required min="0" step="1000">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-image"></i> 제품 이미지 URL *</label>
                        <input type="url" id="productImageUrl" required placeholder="https://example.com/image.jpg" 
                               oninput="previewImageFromUrl()">
                        <small style="color: #666; display: block; margin-top: 5px;">
                            💡 이미지 URL을 입력하세요 (예: https://via.placeholder.com/400)
                        </small>
                        <div id="imagePreview" style="display:none; margin-top:10px;">
                            <img id="previewImg" style="max-width: 200px; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-gem"></i> 재료</label>
                        <input type="text" id="productMaterials" placeholder="예: 천연 헤마타이트, 실버 체인">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-heart"></i> 건강 효능</label>
                        <input type="text" id="productBenefits" placeholder="예: 혈액순환, 피로 회복">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-align-left"></i> 제품 설명</label>
                        <textarea id="productDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-birthday-cake"></i> 탄생석 (해당되는 월 모두 선택)</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="1" style="margin-right: 5px;"> 1월 (가넷)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="2" style="margin-right: 5px;"> 2월 (자수정)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="3" style="margin-right: 5px;"> 3월 (아쿠아마린)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="4" style="margin-right: 5px;"> 4월 (다이아몬드)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="5" style="margin-right: 5px;"> 5월 (에메랄드)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="6" style="margin-right: 5px;"> 6월 (진주)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="7" style="margin-right: 5px;"> 7월 (루비)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="8" style="margin-right: 5px;"> 8월 (페리도트)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="9" style="margin-right: 5px;"> 9월 (사파이어)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="10" style="margin-right: 5px;"> 10월 (오팔)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="11" style="margin-right: 5px;"> 11월 (토파즈)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="birthstone-checkbox" value="12" style="margin-right: 5px;"> 12월 (터키석)
                            </label>
                        </div>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">
                            💡 팁: 헤마타이트는 모든 월에 해당되며, 여러 원석 조합 제품은 여러 월을 선택할 수 있습니다
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-gift"></i> 특별한 날 (해당되는 날 모두 선택)</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="occasion-checkbox" value="valentine" style="margin-right: 5px;"> 💕 발렌타인데이 (2/14)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="occasion-checkbox" value="whiteday" style="margin-right: 5px;"> 🤍 화이트데이 (3/14)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="occasion-checkbox" value="parents" style="margin-right: 5px;"> 🌹 어버이날 (5/8)
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="occasion-checkbox" value="birthday" style="margin-right: 5px;"> 🎂 생일 선물
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="occasion-checkbox" value="anniversary" style="margin-right: 5px;"> 💍 결혼기념일
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="occasion-checkbox" value="graduation" style="margin-right: 5px;"> 🎓 졸업 선물
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" class="occasion-checkbox" value="christmas" style="margin-right: 5px;"> 🎄 크리스마스 (12/25)
                            </label>
                        </div>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">
                            💡 팁: 선물로 적합한 제품은 여러 기념일을 선택할 수 있습니다
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productFeatured">
                            추천 제품으로 설정
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="productInStock" checked>
                            재고 있음
                        </label>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 저장
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeProductModal()">
                            <i class="fas fa-times"></i> 취소
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Discount Modal -->
    <div id="discountModal" class="modal">
        <div class="modal-overlay" onclick="closeDiscountModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="discountModalTitle">새 할인 추가</h2>
                <button class="modal-close" onclick="closeDiscountModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="discountForm" onsubmit="handleDiscountSubmit(event)">
                    <input type="hidden" id="discountId">
                    
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> 할인명 *</label>
                        <input type="text" id="discountName" required placeholder="예: 오픈 기념 할인">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-percent"></i> 할인율 (%) *</label>
                        <input type="number" id="discountRate" required min="1" max="100" placeholder="예: 20">
                        <small style="color: #666;">1% ~ 100% 사이 값을 입력하세요</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-calendar-alt"></i> 시작일 *</label>
                        <input type="date" id="discountStartDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-calendar-check"></i> 종료일 *</label>
                        <input type="date" id="discountEndDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-info-circle"></i> 설명</label>
                        <textarea id="discountDescription" rows="2" placeholder="할인에 대한 간단한 설명 (선택사항)"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="discountActive" style="margin-right: 8px;">
                            <i class="fas fa-check-circle" style="margin-right: 5px; color: #4caf50;"></i>
                            활성화 (체크하면 즉시 적용됩니다)
                        </label>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 저장
                        </button>
                        <button type="button" onclick="closeDiscountModal()" class="btn btn-secondary">
                            <i class="fas fa-times"></i> 취소
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <div class="toast-content">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage"></span>
        </div>
    </div>

    <script src="js/admin.js?v=2.5.18"></script>
    <script src="js/admin-search-sort.js?v=2.5.18"></script>
    <script src="js/admin-dashboard.js?v=2.5.18"></script>
    <script src="js/admin-discounts.js?v=2.5.18"></script>
    <script src="js/admin-notifications.js?v=2.5.18"></script>
    <script src="js/admin-export.js?v=2.5.18"></script>
    <script src="js/admin-shipping.js?v=2.5.18"></script>
    
    <!-- ✅ 모든 스크립트 로드 확인 및 강제 초기화 -->
    <script>
    // 스크립트 로드 완료 후 실행
    window.addEventListener('load', function() {
        console.log('✅ 모든 관리자 스크립트 로드 완료');
        console.log('- searchProducts:', typeof searchProducts);
        console.log('- renderProductsTable:', typeof renderProductsTable);
        console.log('- loadDashboard:', typeof loadDashboard);
        console.log('- loadRecentProducts:', typeof loadRecentProducts);
        
        // 강제 초기화 - 로그인되어 있으면 대시보드 로드
        const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
        if (isLoggedIn === 'true') {
            console.log('🔄 [Init] 강제 초기화 시작...');
            // 1초 후 대시보드 로드 (모든 스크립트가 완전히 로드되도록 충분한 시간 제공)
            setTimeout(function() {
                if (typeof loadDashboard === 'function') {
                    console.log('✅ [Init] 대시보드 로드 시작');
                    loadDashboard();
                } else {
                    console.error('❌ [Init] loadDashboard 함수를 찾을 수 없음');
                }
            }, 1000);
        }
    });
    
    // 전역 변수 등록 (다른 스크립트에서 접근 가능하도록)
    window.adminProducts = window.adminProducts || [];
    window.adminOrders = window.adminOrders || [];
    </script>
    
    <!-- 🔧 주문 모달 수정 패치 (products 파싱 개선) -->
    <script>
    console.log('✅ 주문 모달 수정 패치 로드됨 (v1.1)');
    
    // 페이지 로드 완료 후 viewOrderDetail 함수 오버라이드
    window.addEventListener('DOMContentLoaded', function() {
        console.log('🔧 viewOrderDetail 함수 오버라이드 시작');
        
        // 원본 함수 오버라이드
        window.viewOrderDetail = function(orderId) {
            console.log('🔧 수정된 viewOrderDetail 호출됨:', orderId);
            
            const order = adminOrders.find(o => o.id === orderId);
            if (!order) {
                console.error('❌ 주문을 찾을 수 없음:', orderId);
                return;
            }
            
            console.log('📦 주문 데이터:', order);
            console.log('📦 products 타입:', typeof order.products);
            console.log('📦 products 값:', order.products);
            
            // 🔧 핵심 수정: products 파싱 개선
            let products = [];
            try {
                if (typeof order.products === 'string') {
                    console.log('📝 문자열 형태 products → JSON 파싱');
                    products = JSON.parse(order.products);
                } else if (Array.isArray(order.products)) {
                    console.log('📝 배열 형태 products → 그대로 사용');
                    products = order.products;
                } else if (typeof order.products === 'object' && order.products !== null) {
                    console.log('📝 객체 형태 products → 배열로 변환');
                    products = [order.products];
                } else {
                    console.warn('⚠️ 알 수 없는 products 형태:', order.products);
                    products = [];
                }
            } catch (e) {
                console.error('❌ 제품 파싱 오류:', e, order.products);
                products = [];
            }
            
            console.log('✅ 최종 products:', products);
            
            const orderDate = new Date(order.order_date || order.created_at);
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'orderModal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeOrderModal()"></div>
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2><i class="fas fa-receipt"></i> 주문 상세</h2>
                        <button class="modal-close" onclick="closeOrderModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="max-height:70vh;overflow-y:auto;">
                        <div style="display:grid;gap:20px;">
                            <div style="background:#f8f8f8;padding:20px;border-radius:10px;">
                                <h3 style="margin-bottom:15px;"><i class="fas fa-info-circle"></i> 주문 정보</h3>
                                <p><strong>주문번호:</strong> ${order.order_number}</p>
                                <p><strong>주문일시:</strong> ${orderDate.toLocaleString('ko-KR')}</p>
                                <p><strong>상태:</strong> ${order.status}</p>
                            </div>
                            
                            <div style="background:#f8f8f8;padding:20px;border-radius:10px;">
                                <h3 style="margin-bottom:15px;"><i class="fas fa-user"></i> 고객 정보</h3>
                                <p><strong>이름:</strong> ${order.customer_name}</p>
                                <p><strong>전화:</strong> ${order.customer_phone}</p>
                                <p><strong>이메일:</strong> ${order.customer_email || '미입력'}</p>
                                <p><strong>카카오톡:</strong> ${order.customer_kakao || '미입력'}</p>
                            </div>
                            
                            <div style="background:#f8f8f8;padding:20px;border-radius:10px;">
                                <h3 style="margin-bottom:15px;"><i class="fas fa-map-marker-alt"></i> 배송 정보</h3>
                                <p>${order.shipping_address}</p>
                                ${order.special_request ? `<p style="margin-top:10px;"><strong>요청사항:</strong> ${order.special_request}</p>` : ''}
                            </div>
                            
                            <div style="background:#f8f8f8;padding:20px;border-radius:10px;">
                                <h3 style="margin-bottom:15px;"><i class="fas fa-shopping-cart"></i> 주문 상품</h3>
                                ${products.length > 0 ? products.map(p => `
                                    <div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:8px;margin-bottom:10px;">
                                        <div>
                                            <strong>${p.name}</strong>
                                            <div style="color:#666;font-size:0.9rem;">수량: ${p.quantity}개</div>
                                        </div>
                                        <div style="font-weight:600;color:#2c5f4f;">
                                            ${(p.price * p.quantity).toLocaleString()}원
                                        </div>
                                    </div>
                                `).join('') : '<p style="color:#999;">제품 정보가 없습니다.</p>'}
                                <div style="text-align:right;padding-top:15px;border-top:2px solid #ddd;margin-top:15px;">
                                    <strong style="font-size:1.2rem;color:#2c5f4f;">
                                        총 ${order.total_amount.toLocaleString()}원
                                    </strong>
                                </div>
                            </div>
                            
                            <div style="background:#f8f8f8;padding:20px;border-radius:10px;">
                                <h3 style="margin-bottom:15px;"><i class="fas fa-edit"></i> 주문 상태 변경</h3>
                                <div style="display:flex;flex-wrap:wrap;gap:10px;">
                                    <button onclick="changeOrderStatus('${order.id}', '접수')" class="btn btn-sm" style="background:#3498db;">접수</button>
                                    <button onclick="changeOrderStatus('${order.id}', '확인중')" class="btn btn-sm" style="background:#f39c12;">확인중</button>
                                    <button onclick="changeOrderStatus('${order.id}', '배송준비')" class="btn btn-sm" style="background:#9b59b6;">배송준비</button>
                                    <button onclick="changeOrderStatus('${order.id}', '배송중')" class="btn btn-sm" style="background:#1abc9c;">배송중</button>
                                    <button onclick="changeOrderStatus('${order.id}', '배송완료')" class="btn btn-sm" style="background:#27ae60;">배송완료</button>
                                    <button onclick="changeOrderStatus('${order.id}', '취소')" class="btn btn-sm" style="background:#e74c3c;">취소</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ 모달 생성 완료');
        };
        
        console.log('✅ viewOrderDetail 함수 오버라이드 완료');
    });
    </script>
</body>
</html>
